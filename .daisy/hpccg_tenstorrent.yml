on:
  push:
    branches:
      - master
  pull_request:
    types: [opened, reopened, synchronize, ready_for_review]
  schedule:
    - cron: "0 2 * * *"

parameters:
  container: daisytuner/x64-tenstorrent:0.63.0-latest
  timeout: 60
  partitions:
    - zinnia-ci

steps:
  build: |
    export DOCC_CI=regions

    # Baseline
    docc-cpp -O3 -g -mllvm -docc-tune=none main.cpp generate_matrix.cpp HPCCG.cpp ddot.cpp HPC_sparsemv.cpp waxpby.cpp YAML_Doc.cpp YAML_Element.cpp mytimer.cpp -lm -o hpccg.out
    
    # Auto-parallelized with OpenMP
    docc-cpp -O3 -g -mllvm -docc-tune=openmp -mllvm -docc-einsum main.cpp generate_matrix.cpp HPCCG.cpp ddot.cpp HPC_sparsemv.cpp waxpby.cpp YAML_Doc.cpp YAML_Element.cpp mytimer.cpp -lm -lblas -o hpccg.openmp.out

    # Auto-offloaded to Tenstorrent (temporarily: rtl)

    # Build rtl
    cd tenstorrent/rtl
    mkdir build && cd build
    # cmake .. -DCMAKE_BUILD_TYPE=Release
    # make -j$(nproc)
    # mv libdaisy_tt_rt.so ../../../libdaisy_tt_rt.so
    # rm -rf *

    export CPATH=$DOCC_ROOT/include:$CPATH
    export LIBRARY_PATH=$DOCC_ROOT/lib:$LIBRARY_PATH

    ## Build intrumented rtl
    cmake .. -DCMAKE_BUILD_TYPE=Release -DENABLE_DAISY_RTL=ON
    make -j$(nproc)
    # mv libdaisy_tt_rt.so libdaisy_tt_rt.instrumented.so
    # mv ../../../libdaisy_tt_rt.so .

    # Build HPCCG with Tenstorrent rtl
    cd ../../../
    docc-cpp -O3 -g -mllvm -docc-tune=tenstorrent -mllvm -docc-einsum -mllvm -docc-offloading-force-synchronous -DUSING_TT_RTL main.cpp generate_matrix.cpp HPCCG.cpp ddot.cpp HPC_sparsemv.cpp waxpby.cpp YAML_Doc.cpp YAML_Element.cpp mytimer.cpp -lm -L./tenstorrent/rtl/build -ldaisy_tt_rt -o hpccg.tenstorrent.out

  run:
    hpccg:
      command: ./hpccg.out 50 50 50
      energy: true
    hpccg_openmp:
      command: ./hpccg.openmp.out 50 50 50
      energy: true
      env:
        OMP_NUM_THREADS: 8
    hpccg_tenstorrent:
      command: ./hpccg.tenstorrent.out 50 50 50
      energy: true
      env:
        TT_HPCCG_KERNEL_DIR: /workspace/tenstorrent/rtl/kernels
        LD_LIBRARY_PATH: /tenstorrent/tt-metalium/build/lib:/workspace/tenstorrent/rtl/build:$LD_LIBRARY_PATH
